<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Restaurant POS System</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load React, React DOM, and Babel for JSX compilation -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Custom Tailwind Configuration -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'indigo-600': '#4f46e5',
                        'indigo-700': '#4338ca',
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-gray-100 antialiased min-h-screen">

    <!-- This is the container where the React App will render -->
    <div id="root"></div>

    <!-- The React POS Application Code -->
    <script type="text/babel">
        // ----------------------------------------------------------------------------------
        // !!! CRITICAL CONFIGURATION STEP !!!
        // You MUST change 'http://localhost:3000' to the IP address or domain where your 
        // Node.js backend (MYAPP) is running and accessible from the Android device.
        // Example: If your server IP is 192.168.1.100, set this to: 'http://192.168.1.100:3000/api'
        // ----------------------------------------------------------------------------------
        const API_BASE_URL = 'http://localhost:3000/api'; 
        const WAITER_ID = "WTR-456";

        // Define the screens for simple state-based navigation
        const SCREENS = {
            TABLES: 'tables',
            ORDER_ENTRY: 'order',
            PAYMENT: 'payment',
            BILL: 'bill'
        };

        /**
         * Custom hook for handling API calls with simple retry logic.
         */
        const useApiFetcher = () => {
            const fetchWithRetry = React.useCallback(async (url, options = {}, retries = 3) => {
                const fullUrl = url.startsWith('http') ? url : `${API_BASE_URL}${url}`;
                
                for (let i = 0; i < retries; i++) {
                    try {
                        const response = await fetch(fullUrl, options);
                        const data = await response.json();
                        
                        if (!response.ok) {
                            // FIX: Changed template literal to string concatenation to avoid Babel parsing error
                            throw new Error(data.message || "API Error: " + response.status + " " + response.statusText);
                        }
                        return data;
                    } catch (error) {
                        console.error(`Attempt ${i + 1} failed for ${fullUrl}:`, error);
                        if (i === retries - 1) throw error;
                        // Wait using exponential backoff before retrying
                        await new Promise(resolve => setTimeout(resolve, Math.pow(2, i) * 1000)); 
                    }
                }
            }, []);
            return fetchWithRetry;
        };


        // --- Component A: Tab Selection View ---

        const TableSelectionView = ({ navigate, setTableId }) => {
            const fetchWithRetry = useApiFetcher();
            const [tables, setTables] = React.useState([]);
            const [loading, setLoading] = React.useState(true);
            const [error, setError] = React.useState(null);

            React.useEffect(() => {
                const fetchTables = async () => {
                    try {
                        // Fetching tables data from /tables endpoint
                        const data = await fetchWithRetry('/tables');
                        setTables(data);
                    } catch (err) {
                        setError("Could not load tables. Ensure your backend is running and API_BASE_URL is correct.");
                        console.error(err);
                    } finally {
                        setLoading(false);
                    }
                };
                fetchTables();
            }, [fetchWithRetry]);

            const handleTableSelect = (id) => {
                setTableId(id);
                navigate(SCREENS.ORDER_ENTRY);
            };

            if (loading) return <div className="text-center p-8 text-xl text-indigo-600 font-semibold">Loading Tables...</div>;
            if (error) return <div className="text-center p-8 text-xl text-red-600 font-semibold">{error}</div>;

            return (
                <div className="p-4 grid grid-cols-2 md:grid-cols-3 gap-4 overflow-y-auto h-full">
                    <h2 className="col-span-full text-2xl font-bold text-gray-800 mb-4">Select Table</h2>
                    {tables.map(table => (
                        <div 
                            key={table.id}
                            onClick={() => handleTableSelect(table.id)}
                            className={`
                                p-6 text-center rounded-xl shadow-lg cursor-pointer transition-all duration-200
                                ${table.status === 'occupied' 
                                    ? 'bg-red-400 text-white hover:bg-red-500' 
                                    : table.status === 'dirty' 
                                        ? 'bg-yellow-400 text-gray-800 hover:bg-yellow-500' 
                                        : 'bg-green-400 text-white hover:bg-green-500'}
                            `}
                        >
                            <span className="block text-3xl font-extrabold">Table {table.id}</span>
                            <span className="text-sm capitalize">{table.status || 'Available'}</span>
                        </div>
                    ))}
                </div>
            );
        };


        // --- Component B: Order Entry View (Placing Orders) ---

        const OrderEntryView = ({ navigate, tableId, setOrderId }) => {
            const fetchWithRetry = useApiFetcher();
            const [menuItems, setMenuItems] = React.useState([]);
            const [cart, setCart] = React.useState([]);
            const [loading, setLoading] = React.useState(true);
            const [error, setError] = React.useState(null);

            React.useEffect(() => {
                const fetchMenu = async () => {
                    try {
                        // Fetch menu_items data from /menu_items endpoint
                        const data = await fetchWithRetry('/menu_items');
                        setMenuItems(data);
                    } catch (err) {
                        setError("Could not load menu. Check API connection.");
                        console.error(err);
                    } finally {
                        setLoading(false);
                    }
                };
                fetchMenu();
            }, [fetchWithRetry]);

            const addToCart = (item) => {
                setCart(prevCart => {
                    const existingItem = prevCart.find(i => i.id === item.id);
                    if (existingItem) {
                        return prevCart.map(i => 
                            i.id === item.id ? { ...i, quantity: i.quantity + 1 } : i
                        );
                    }
                    return [...prevCart, { ...item, quantity: 1 }];
                });
            };

            const updateQuantity = (id, change) => {
                setCart(prevCart => {
                    const updatedCart = prevCart.map(i => 
                        i.id === id ? { ...i, quantity: i.quantity + change } : i
                    ).filter(i => i.quantity > 0);
                    return updatedCart;
                });
            };

            const calculateTotal = React.useMemo(() => 
                cart.reduce((total, item) => total + item.price * item.quantity, 0).toFixed(2)
            , [cart]);

            const placeOrder = async () => {
                if (cart.length === 0) {
                    // Custom modal/message box should be used instead of alert in production
                    alert("The cart is empty! Please add items before placing the order."); 
                    return;
                }

                const orderPayload = {
                    table_id: tableId,
                    waiter_id: WAITER_ID,
                    items: cart.map(item => ({
                        item_id: item.id,
                        quantity: item.quantity
                    }))
                };

                try {
                    setLoading(true);
                    // Place order via POST /orders endpoint
                    const data = await fetchWithRetry('/orders', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(orderPayload)
                    });

                    // Server returns the new order_id
                    setOrderId(data.order_id); 
                    navigate(SCREENS.PAYMENT);
                    setLoading(false);
                } catch (err) {
                    setError("Failed to place order. Check server logic.");
                    setLoading(false);
                    console.error(err);
                }
            };

            if (loading) return <div className="text-center p-8 text-xl text-indigo-600 font-semibold">Loading Menu...</div>;
            if (error) return <div className="text-center p-8 text-xl text-red-600 font-semibold">{error}</div>;

            return (
                <div className="flex flex-col md:flex-row h-full max-h-[90vh] overflow-hidden">
                    {/* Menu Display (Left/Top on tablet/mobile) */}
                    <div className="flex-1 p-4 bg-gray-50 overflow-y-auto order-2 md:order-1">
                        <h3 className="text-xl font-bold mb-4 border-b pb-2 text-indigo-600">Menu Items</h3>
                        <div className="grid grid-cols-2 lg:grid-cols-3 gap-3">
                            {menuItems.map(item => (
                                <div 
                                    key={item.id}
                                    onClick={() => addToCart(item)}
                                    className="p-3 bg-white border border-gray-200 rounded-lg shadow-md cursor-pointer hover:bg-indigo-50 transition duration-150"
                                >
                                    <div className="font-semibold text-gray-800">{item.name}</div>
                                    <div className="text-sm text-gray-500">${item.price.toFixed(2)}</div>
                                </div>
                            ))}
                        </div>
                    </div>

                    {/* Order Cart (Right/Bottom on tablet/mobile) */}
                    <div className="w-full md:w-80 border-l border-gray-200 bg-white flex flex-col order-1 md:order-2 shrink-0">
                        <div className="p-4 flex-grow overflow-y-auto">
                            <h3 className="text-xl font-bold mb-4 text-gray-800">
                                Cart - Table {tableId}
                            </h3>
                            <div className="space-y-3">
                                {cart.length === 0 ? (
                                    <p className="text-gray-500 italic">Cart is empty.</p>
                                ) : (
                                    cart.map(item => (
                                        <div key={item.id} className="flex justify-between items-center bg-gray-50 p-3 rounded-lg">
                                            <div className="flex-1">
                                                <div className="font-medium text-sm">{item.name}</div>
                                                <div className="text-xs text-gray-500">${(item.price * item.quantity).toFixed(2)}</div>
                                            </div>
                                            <div className="flex items-center space-x-1">
                                                <button 
                                                    onClick={() => updateQuantity(item.id, -1)} 
                                                    className="bg-red-400 text-white w-6 h-6 rounded-full text-sm hover:bg-red-500 shadow-sm"
                                                    title="Decrease Quantity"
                                                >
                                                    -
                                                </button>
                                                <span className="font-semibold w-6 text-center">{item.quantity}</span>
                                                <button 
                                                    onClick={() => updateQuantity(item.id, 1)} 
                                                    className="bg-green-400 text-white w-6 h-6 rounded-full text-sm hover:bg-green-500 shadow-sm"
                                                    title="Increase Quantity"
                                                >
                                                    +
                                                </button>
                                            </div>
                                        </div>
                                    ))
                                )}
                            </div>
                        </div>

                        {/* Footer and Action Button */}
                        <div className="p-4 border-t border-gray-200">
                            <div className="flex justify-between items-center text-xl font-bold mb-3 text-gray-800">
                                <span>Total:</span>
                                <span>${calculateTotal}</span>
                            </div>
                            <button 
                                onClick={placeOrder}
                                disabled={cart.length === 0 || loading}
                                className="w-full bg-indigo-600 text-white py-3 rounded-xl font-semibold text-lg shadow-lg hover:bg-indigo-700 disabled:bg-indigo-300 transition duration-150"
                            >
                                {loading ? 'Placing Order...' : 'Place Order & Go to Payment'}
                            </button>
                            <button 
                                onClick={() => navigate(SCREENS.TABLES)}
                                className="w-full mt-2 text-sm text-gray-500 hover:text-gray-800 transition duration-150"
                            >
                                Cancel & Back to Tables
                            </button>
                        </div>
                    </div>
                </div>
            );
        };


        // --- Component C: Payment View (Taking Payment) ---

        const PaymentView = ({ navigate, orderId, tableId, setBillData }) => {
            const fetchWithRetry = useApiFetcher();
            const [status, setStatus] = React.useState('pending'); // 'pending', 'deducting', 'ready', 'processing', 'completed', 'error'
            const [message, setMessage] = React.useState('Confirming order and preparing for payment...');

            const paymentMethods = [
                { key: 'cash', label: 'Cash', color: 'bg-green-500 hover:bg-green-600' },
                { key: 'card', label: 'Card (Credit/Debit)', color: 'bg-blue-500 hover:bg-blue-600' },
                { key: 'mobile', label: 'Mobile Pay (Apple/Google)', color: 'bg-indigo-500 hover:bg-indigo-600' },
            ];

            // Step 1: Complete Order and Deduct Inventory (POST /orders/:orderId/complete)
            React.useEffect(() => {
                const completeOrder = async () => {
                    setStatus('deducting');
                    setMessage('1/2: Sending order to kitchen and deducting inventory...');
                    try {
                        // FIX: Replaced template literal with string concatenation for Babel compatibility
                        await fetchWithRetry('/orders/' + orderId + '/complete', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                        });
                        
                        setStatus('ready');
                        setMessage('Inventory confirmed! Ready to take payment.');

                    } catch (err) {
                        setStatus('error');
                        setMessage('Error completing order ' + orderId + '. Please check inventory status.');
                        console.error(err);
                    }
                };

                if (orderId) {
                    completeOrder();
                }
            }, [orderId, fetchWithRetry]);

            // Step 2: Process Payment (POST /orders/:orderId/pay)
            const processPayment = async (paymentMethod) => {
                if (status !== 'ready') return;

                setStatus('processing');
                setMessage('2/2: Processing payment via ' + paymentMethod + '...');
                
                const paymentPayload = { paymentMethod };

                try {
                    // FIX: Replaced template literal with string concatenation for Babel compatibility
                    const bill = await fetchWithRetry('/orders/' + orderId + '/pay', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(paymentPayload)
                    });

                    // Server returns the final, structured bill
                    setBillData(bill);
                    setStatus('completed');
                    navigate(SCREENS.BILL);

                } catch (err) {
                    setStatus('error');
                    setMessage('Payment failed via ' + paymentMethod + ': ' + err.message);
                    console.error(err);
                }
            };

            return (
                <div className="p-8 bg-white h-full flex flex-col justify-center items-center">
                    <div className={`p-6 rounded-xl shadow-lg mb-8 w-full max-w-sm text-center
                        ${status === 'ready' ? 'bg-green-100 border-green-400' : 
                          status === 'error' ? 'bg-red-100 border-red-400' : 'bg-blue-100 border-blue-400'}`}
                    >
                        <div className="text-3xl font-bold text-gray-800">Table {tableId}</div>
                        <div className="text-xl font-semibold mt-2 text-indigo-600">Order ID: {orderId}</div>
                        <p className="mt-4 text-gray-700 font-medium">{message}</p>
                    </div>
                    
                    {status === 'ready' && (
                        <div className="w-full max-w-sm space-y-4">
                            <h3 className="text-xl font-bold text-center mb-4 text-gray-800">Select Payment Method</h3>
                            {paymentMethods.map(method => (
                                <button 
                                    key={method.key}
                                    onClick={() => processPayment(method.key)}
                                    className={`w-full text-white py-4 rounded-xl font-semibold text-lg shadow-xl transition duration-150 ${method.color}`}
                                >
                                    Pay with {method.label}
                                </button>
                            ))}
                        </div>
                    )}

                    {status === 'error' && (
                         <button 
                            onClick={() => navigate(SCREENS.TABLES)}
                            className="mt-6 text-sm text-gray-500 hover:text-gray-800 transition duration-150"
                        >
                            Back to Tables
                        </button>
                    )}

                </div>
            );
        };


        // --- Component D: Bill Display View ---

        const BillView = ({ navigate, billData, setTableId, setOrderId, setBillData }) => {
            // Reset state and navigate back to the main screen
            const handleNewOrder = () => {
                setTableId(null);
                setOrderId(null);
                setBillData(null);
                navigate(SCREENS.TABLES);
            };

            return (
                <div className="p-8 bg-white h-full flex flex-col items-center">
                    <div className="max-w-md w-full border-2 border-dashed border-indigo-300 p-6 rounded-xl shadow-2xl bg-gray-50">
                        <h2 className="text-3xl font-extrabold text-center text-indigo-700 mb-6">Receipt / Payment Complete!</h2>
                        
                        <div className="space-y-2 mb-6 border-b pb-4">
                            <div className="flex justify-between text-sm text-gray-600">
                                <span>Order ID:</span>
                                <span className="font-medium">{billData.order_id}</span>
                            </div>
                            <div className="flex justify-between text-sm text-gray-600">
                                <span>Table ID:</span>
                                <span className="font-medium">{billData.table_id}</span>
                            </div>
                            <div className="flex justify-between text-sm text-gray-600">
                                <span>Payment Method:</span>
                                <span className="font-medium capitalize">{billData.paymentMethod}</span>
                            </div>
                        </div>

                        <h3 className="text-lg font-bold text-gray-800 mb-3">Items:</h3>
                        <ul className="space-y-1 mb-6 text-sm">
                            {/* Assumes billData.items is structured with name, quantity, and subtotal */}
                            {billData.items.map((item, index) => (
                                <li key={index} className="flex justify-between">
                                    <span className="text-gray-700">{item.name} (x{item.quantity})</span>
                                    <span className="font-mono">${item.subtotal.toFixed(2)}</span>
                                </li>
                            ))}
                        </ul>

                        <div className="border-t pt-4 space-y-2">
                            <div className="flex justify-between text-base">
                                <span className="font-medium">Subtotal:</span>
                                <span className="font-semibold">${billData.subtotal.toFixed(2)}</span>
                            </div>
                            <div className="flex justify-between text-base">
                                <span className="font-medium">Tax ({billData.tax_rate * 100}%):</span>
                                <span className="font-semibold">${billData.tax_amount.toFixed(2)}</span>
                            </div>
                            <div className="flex justify-between text-2xl font-extrabold text-indigo-700 pt-2">
                                <span>TOTAL PAID:</span>
                                <span>${billData.total.toFixed(2)}</span>
                            </div>
                        </div>
                    </div>

                    <button 
                        onClick={handleNewOrder}
                        className="mt-8 bg-indigo-600 text-white py-3 px-8 rounded-xl font-semibold text-lg shadow-lg hover:bg-indigo-700 transition duration-150"
                    >
                        Start New Order
                    </button>
                </div>
            );
        };


        // --- Main Application Component ---

        const App = () => {
            const [screen, setScreen] = React.useState(SCREENS.TABLES);
            const [tableId, setTableId] = React.useState(null);
            const [orderId, setOrderId] = React.useState(null);
            const [billData, setBillData] = React.useState(null);

            // Simple navigation function
            const navigate = (nextScreen) => setScreen(nextScreen);

            // Render the correct screen based on the current state
            const renderScreen = () => {
                switch (screen) {
                    case SCREENS.TABLES:
                        return (
                            <TableSelectionView 
                                navigate={navigate} 
                                setTableId={setTableId} 
                            />
                        );
                    case SCREENS.ORDER_ENTRY:
                        if (!tableId) return navigate(SCREENS.TABLES);
                        return (
                            <OrderEntryView 
                                navigate={navigate} 
                                tableId={tableId} 
                                setOrderId={setOrderId} 
                            />
                        );
                    case SCREENS.PAYMENT:
                        if (!orderId) return navigate(SCREENS.TABLES);
                        return (
                            <PaymentView 
                                navigate={navigate} 
                                orderId={orderId} 
                                tableId={tableId} 
                                setBillData={setBillData}
                            />
                        );
                    case SCREENS.BILL:
                        if (!billData) return navigate(SCREENS.TABLES);
                        return (
                            <BillView 
                                navigate={navigate} 
                                billData={billData}
                                setTableId={setTableId}
                                setOrderId={setOrderId}
                                setBillData={setBillData}
                            />
                        );
                    default:
                        return navigate(SCREENS.TABLES);
                }
            };

            return (
                <div className="min-h-screen bg-gray-100 flex items-center justify-center p-4">
                    {/* The main POS application wrapper, simulating a mobile/tablet view */}
                    <div className="bg-white shadow-2xl rounded-2xl w-full h-[90vh] max-w-3xl border border-gray-200 overflow-hidden">
                        {renderScreen()}
                    </div>
                </div>
            );
        }

        // Render the application to the root element
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>

</body>
</html>